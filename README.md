# StackMuncher Inbox for Report Submissions

There are multiple crates in this project. They form parts of a pipeline from accepting a stack report from a member to updating the member's profile. 

# Inbox Crate

This app is used as a Lambda function for receiving user report submissions.

The client app signs and submits one or more reports at the end of its stack analysis. The submissions contain the report in the body of HTTP POST message and several meta-headers:

* **StackMuncher_Key**: the public key of the user (required)
* **StackMuncher_Sig**: the signature generated by the client app (required)

The sole purpose of this app is to save validated stack report submissions from devs and return a response as soon as possible.
The validation is limited to checking the signature using the public key included in the submission.
Validated reports are saved as-is with the key and timestamp of the submission.
E.g. `s3://stm-reports-dev/queue/1621680890_7prBWD7pzYk2czeXZeXzjxjDQbnuka2RLShdW5AxWuk7.json`, where:
* queue: prefix for new, unprocessed reports
* 1621680890: an epoch timestamp of the submission
* 7prBWD7pzYk2czeXZeXzjxjDQbnuka2RLShdW5AxWuk7: dev's public key in base58 format

## Deployment

The deployment should be automated. This section is a quick memo for manual deployment.

#### Lambda deployment

Create function called `stm_inbox` with `stm_inbox` role, a custom runtime and customize these settings:
* env vars: see [config.rs](./src/config.rs) for the full list
* timeout: 30s
* reserved concurrency: 25
* async invocation: ... TBC

```
cargo build --release --target x86_64-unknown-linux-gnu
cp ./target/x86_64-unknown-linux-gnu/release/stm_inbox ./bootstrap && zip proxy.zip bootstrap && rm bootstrap
aws lambda update-function-code --region us-east-1 --function-name stm_inbox --zip-file fileb://proxy.zip
```

#### API Gateway

* HTTP API with Lambda
* ANY /{proxy+}
* `stm_inbox` Lambda
* `$default` stage

## Debugging

This app relies on https://github.com/rimutaka/lambda-debug-proxy to run a local copy on your dev machine connected to the GatewayAPI via SQS.
This is a bit of a hack. Watch https://github.com/awslabs/aws-lambda-rust-runtime/issues/260 for possible standardization of this feature.

1. Deploy https://github.com/rimutaka/lambda-debug-proxy in place of *stm_inbox*
2. Configure the request and response SQS queues
3. Add `STM_INBOX_LAMBDA_PROXY_REQ` and `STM_INBOX_LAMBDA_PROXY_RESP` with the queue URLs to your *.bashrc*
4. Use `cargo run` to launch *stm_inbox* app locally
5. Send a request to the GWAPI endpoint to invoke *stm_inbox* 

The above steps should trigger a chain of requests and responses: 
> APIGW -> Lambda *stm_inbox* proxy -> SQS Request Queue -> the locally run *stm_inbox* app -> SQS Response Queue -> Lambda *stm_inbox* proxy -> APIGW

[main.rs](./src/main.rs) has sections of code annotated with `#[cfg(debug_assertions)]` to use *lambda-debug-proxy* feature in DEBUG mode or exclude it when built with `--release`.


# Inbox Router Crate

This Lambda app takes new submissions from the inbox in S3, checks the payload and moves them to the member's folder in S3. It does not update the member's profile. 