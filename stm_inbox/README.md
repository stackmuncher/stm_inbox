# StackMuncher Inbox for Report Submissions

This app is used as a Lambda function for receiving stack report submissions. Reports are submitted automatically when someone runs [stackmuncher app](https://github.com/stackmuncher/stm_app) over a local repository. 

A submissions is expected to contain a single gzipped stack report in the body of an HTTP POST message with two meta-headers:

* **StackMuncher_Key**: the public key of the user (required)
* **StackMuncher_Sig**: the signature generated by the client app (required)

The sole purpose of this app is to validate the signature and save the submission in S3 for further processing. It only checks the signature and does not look at the contents at all to return a response as soon as possible.

Validated reports are saved as-is with the key and the timestamp of the submission.
E.g. `s3://stm-reports-dev/queue/1621680890_7prBWD7pzYk2czeXZeXzjxjDQbnuka2RLShdW5AxWuk7.json`, where:
* _queue_: prefix for new, unprocessed reports
* _1621680890_: an epoch timestamp of the submission
* _7prBWD7pzYk2czeXZeXzjxjDQbnuka2RLShdW5AxWuk7_: the dev's public key in base58 format

## Lambda deployment

Create function called `stm_inbox` with `stm_inbox` role, a custom runtime and customize these settings:
* env vars: see [config.rs](./src/config.rs) for the full list
* timeout: 30s
* reserved concurrency: 25
* async invocation: do not retry

```
cargo build --release --target x86_64-unknown-linux-gnu
cp ./target/x86_64-unknown-linux-gnu/release/stm_inbox ./bootstrap && zip proxy.zip bootstrap && rm bootstrap
aws lambda update-function-code --region us-east-1 --function-name stm_inbox --zip-file fileb://proxy.zip
```

#### API Gateway

* HTTP API with Lambda
* ANY /{proxy+}
* `stm_inbox` Lambda
* `$default` stage

## Debugging

This app relies on https://github.com/rimutaka/lambda-debug-proxy to run a local copy on your dev machine connected to the GatewayAPI via SQS.

1. Deploy https://github.com/rimutaka/lambda-debug-proxy in place of *stm_inbox*
2. Configure the request and response SQS queues
3. Add `STM_INBOX_LAMBDA_PROXY_REQ` and `STM_INBOX_LAMBDA_PROXY_RESP` with the queue URLs to your *.bashrc*
4. Use `cargo run` to launch *stm_inbox* app locally
5. Send a request to the GWAPI endpoint to invoke *stm_inbox* 

The above steps should trigger a chain of requests and responses: 
> APIGW -> Lambda *stm_inbox* proxy -> SQS Request Queue -> the locally run *stm_inbox* app -> SQS Response Queue -> Lambda *stm_inbox* proxy -> APIGW

[main.rs](./src/main.rs) has sections of code annotated with `#[cfg(debug_assertions)]` to use *lambda-debug-proxy* feature in DEBUG mode or exclude it when built with `--release`.
